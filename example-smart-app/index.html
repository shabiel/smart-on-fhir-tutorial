<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv='X-UA-Compatible' content='IE=edge' />
    <meta http-equiv='Content-Type' content='text/html; charset=utf-8' />
    <title>Sam's-SMART-App</title>

    <link rel='stylesheet' type='text/css' href='./src/css/example-smart-app.css'>
    <!--
      Temporarily disable cerner-smart-embeddable-lib
      <link rel='stylesheet' type='text/css' href='./lib/css/cerner-smart-embeddable-lib-1.0.0.min.css'>
    -->
  </head>
  <body>
    <div id='errors'>
    </div>
    <div id="loading" class="spinner">
      <div class="bounce1"></div>
      <div class="bounce2"></div>
      <div class="bounce3"></div>
    </div>
    <div id='holder' >
      <h2>Sam's-SMART-App</h2>

      <h2>Patient Resource</h2>
      <table>
        <tr>
          <th>First Name:</th>
          <td id='fname'></td>
        </tr>
        <tr>
          <th>Last Name:</th>
          <td id='lname'></td>
        </tr>
        <tr>
          <th>Gender:</th>
          <td id='gender'></td>
        </tr>
        <tr>
          <th>Date of Birth:</th>
          <td id='birthdate'></td>
        </tr>
        <tr>
          <th>ICN:</th>
          <td id='ICN'></td>
        </tr>
      </table>
      <h2>Location Data</h2>
      <table>
        <tr>
          <th>Encounter Organization</th>
          <td id='orgName'></td>
        </tr>
        <tr>
          <th>Organization Station Number</th>
          <td id='sta'></td>

        </tr>
      </table>
    </div>
    <!-- Required JS files to enable this page to embed within an MPage -->
    <!--
      Temporarily disable cerner-smart-embeddable-lib
      <script src='https://cdnjs.cloudflare.com/ajax/libs/babel-polyfill/6.26.0/polyfill.min.js'></script>
      <script src='./lib/js/cerner-smart-embeddable-lib-1.0.0.min.js'></script>
    -->

    <!-- FHIR Client JS Library -->
    <script src="https://cdn.jsdelivr.net/npm/fhirclient/build/fhir-client.js"></script>

    <!-- Prevent session bleed caused by single threaded embedded browser and sessionStorage API -->
    <!-- https://github.com/cerner/fhir-client-cerner-additions -->
    <script src='./lib/js/fhir-client-cerner-additions-1.0.0.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script>
      FHIR.oauth2.ready().then(function(client) {

        var myICN;
        var myOrganization;
        var myLocation;
        var stationNumber;

        // Render the current patient (or any error)
        client.patient.read().then(function(pt) 
          {
            console.log(pt);
            myICN = pt.identifier[0].id;

            var gender = pt.gender;
            var birthdate = pt.birthDate;

            var fname = '';
            var lname = '';

            if (typeof pt.name[0] !== 'undefined') {
              fname = pt.name[0].given.join(' ');
              lname = pt.name[0].family;
            }

            document.getElementById('holder').style.display = "block";
            document.getElementById('loading').style.display = "none";
            document.getElementById('fname').innerText = fname;
            document.getElementById('lname').innerText = lname;
            document.getElementById('gender').innerText = gender;
            document.getElementById('birthdate').innerText = birthdate;
            document.getElementById('ICN').innerText = myICN;
          },
          function(error)  {
            document.getElementById('errors').innerHTML += '<p>' + error.message + '</p>'
          }
        );

        // Render the current encounter
        client.encounter.read().then(
          function(enc) {
            console.log(enc);
            myLocation = enc.location[0].location.reference;
            myOrganization = enc.serviceProvider.reference;
          },
          function(error) {
            document.getElementById('errors').innerHTML += '<p>' + error.message + '</p>'
          }
        )
        
        // Get organization data
        .then( function() {
          client.request(myOrganization).then(
            function(org) {
              console.log(org);
              document.getElementById('orgName').innerText = org.name;
              stationNumber = org.identifier[0].value;
              document.getElementById('sta').innerText = stationNumber;
            },
            function(error) {
              document.getElementById('errors').innerHTML += '<p>' + error.message + '</p>'
            }
          );
        });

        // Get Observations (shouldn't work... testing error)
        /*
        client.request('/Observations?patient=' + client.patient.id).then(
          function(obs) {}, // nothing will happen as we don't have access
          function(error) {
            document.getElementById('errors').innerHTML += '<p>' + error.message + '</p>'
          }
        );

        // Get Medications (shoudln't work... another error)
        client.request("/MedicationRequest?patient=" + client.patient.id, {
          resolveReferences: [ "medicationReference" ],
          graph: true
        }).then(
          function(meds) {}, //nothing will happen as we don't have access
          function(error) {
            document.getElementById('errors').innerHTML += '<p>' + error.message + '</p>'
          }
        );
        */

      });
    </script>
  </body>
</html>
